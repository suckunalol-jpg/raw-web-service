<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScriptHost</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #0f0f13;
      color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      padding: 30px 20px;
    }
    h1 { text-align: center; font-size: 2rem; color: #a78bfa; margin-bottom: 6px; }
    .subtitle { text-align: center; color: #666; font-size: 0.85rem; margin-bottom: 30px; }
    .container { max-width: 860px; margin: 0 auto; }

    .card {
      background: #1a1a24;
      border: 1px solid #2a2a3a;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .card h2 { font-size: 1rem; color: #a78bfa; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; }

    label { display: block; font-size: 0.82rem; color: #888; margin-bottom: 5px; }
    input[type="text"], input[type="password"], textarea {
      width: 100%;
      background: #0f0f13;
      border: 1px solid #2a2a3a;
      border-radius: 8px;
      color: #e0e0e0;
      padding: 10px 12px;
      font-size: 0.9rem;
      margin-bottom: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus { border-color: #a78bfa; }
    textarea { font-family: 'Courier New', monospace; resize: vertical; min-height: 160px; }

    button {
      background: #7c3aed;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    button:hover { background: #6d28d9; }
    button.danger { background: #7f1d1d; }
    button.danger:hover { background: #991b1b; }
    button.copy-btn { background: #1e293b; font-size: 0.78rem; padding: 5px 12px; }
    button.copy-btn:hover { background: #334155; }

    .msg { margin-top: 10px; padding: 10px 14px; border-radius: 8px; font-size: 0.85rem; display: none; }
    .msg.success { background: #14532d; color: #86efac; display: block; }
    .msg.error   { background: #7f1d1d; color: #fca5a5; display: block; }

    #script-list { display: flex; flex-direction: column; gap: 10px; }
    .script-item {
      background: #0f0f13;
      border: 1px solid #2a2a3a;
      border-radius: 8px;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .script-top { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .script-name { font-weight: 600; color: #c4b5fd; font-size: 0.95rem; }
    .script-meta { font-size: 0.75rem; color: #555; margin-top: 2px; }
    .script-actions { display: flex; gap: 8px; flex-shrink: 0; }

    .loadstring-row { display: flex; gap: 8px; align-items: center; }
    .url-box {
      flex: 1;
      background: #1a1a24;
      border: 1px solid #2a2a3a;
      border-radius: 6px;
      padding: 8px 12px;
      font-family: 'Courier New', monospace;
      font-size: 0.78rem;
      color: #a0a0b0;
      word-break: break-all;
      white-space: pre-wrap;
      user-select: all;
    }

    .empty { color: #444; text-align: center; padding: 30px; font-size: 0.9rem; }
    .row { display: flex; gap: 14px; }
    .row > * { flex: 1; }
  </style>
</head>
<body>
<div class="container">
  <h1>‚ö° ScriptHost</h1>
  <p class="subtitle">Your personal Lua script cloud</p>

  <div class="card">
    <h2>Upload Script</h2>
    <div class="row">
      <div>
        <label>Script Name (no spaces)</label>
        <input type="text" id="script-name" placeholder="e.g. myscript or esp_v2" />
      </div>
      <div>
        <label>Upload Password</label>
        <input type="password" id="password" placeholder="Your secret password" />
      </div>
    </div>
    <label>Script Content (Lua)</label>
    <textarea id="script-content" placeholder="-- paste your Lua script here"></textarea>
    <button onclick="uploadScript()">Upload Script</button>
    <div id="upload-msg" class="msg"></div>
  </div>

  <div class="card">
    <h2>Your Scripts</h2>
    <div id="script-list"><div class="empty">Loading...</div></div>
  </div>
</div>

<script>
  const BASE = window.location.origin;

  // Store loadstrings by script name so copy buttons can access them safely
  const loadstrings = {};

  async function loadScripts() {
    const res = await fetch('/api/scripts');
    const scripts = await res.json();
    const list = document.getElementById('script-list');

    if (scripts.length === 0) {
      list.innerHTML = '<div class="empty">No scripts yet. Upload one above!</div>';
      return;
    }

    list.innerHTML = '';

    scripts.forEach(s => {
      const rawUrl = `${BASE}/raw/${s.name}`;
      const loadstr = `loadstring(game:HttpGet("${rawUrl}"))()`;
      loadstrings[s.name] = loadstr;

      const item = document.createElement('div');
      item.className = 'script-item';
      item.innerHTML = `
        <div class="script-top">
          <div class="script-info">
            <div class="script-name">üìú ${s.name}</div>
            <div class="script-meta">${s.lines} lines ¬∑ ${(s.size/1024).toFixed(1)}KB ¬∑ ${new Date(s.updated).toLocaleDateString()}</div>
          </div>
          <div class="script-actions">
            <button class="copy-btn" id="copy-${s.name}">Copy</button>
            <button class="danger" id="del-${s.name}">Delete</button>
          </div>
        </div>
        <div class="loadstring-row">
          <div class="url-box" id="ls-${s.name}">${loadstr}</div>
        </div>
      `;
      list.appendChild(item);

      // Attach events via JS so no inline escaping issues
      document.getElementById(`copy-${s.name}`).addEventListener('click', () => {
        copyText(s.name);
      });
      document.getElementById(`del-${s.name}`).addEventListener('click', () => {
        deleteScript(s.name);
      });
    });
  }

  function copyText(name) {
    const text = loadstrings[name];
    navigator.clipboard.writeText(text).then(() => {
      const btn = document.getElementById(`copy-${name}`);
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 1500);
    }).catch(() => {
      // Fallback for older browsers
      const box = document.getElementById(`ls-${name}`);
      const range = document.createRange();
      range.selectNode(box);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
      document.execCommand('copy');
      window.getSelection().removeAllRanges();
      const btn = document.getElementById(`copy-${name}`);
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 1500);
    });
  }

  async function uploadScript() {
    const name = document.getElementById('script-name').value.trim();
    const password = document.getElementById('password').value;
    const content = document.getElementById('script-content').value;
    const msg = document.getElementById('upload-msg');

    const res = await fetch('/api/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, password, content })
    });
    const data = await res.json();

    if (data.success) {
      msg.className = 'msg success';
      msg.textContent = `‚úÖ Uploaded! Use: loadstring(game:HttpGet("${BASE}/raw/${data.name}"))()`;
      document.getElementById('script-name').value = '';
      document.getElementById('script-content').value = '';
      loadScripts();
    } else {
      msg.className = 'msg error';
      msg.textContent = '‚ùå ' + data.error;
    }
  }

  async function deleteScript(name) {
    const password = document.getElementById('password').value;
    if (!password) { alert('Enter your password first!'); return; }
    if (!confirm(`Delete "${name}"?`)) return;

    const res = await fetch(`/api/scripts/${name}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.success) loadScripts();
    else alert('Error: ' + data.error);
  }

  loadScripts();
</script>
</body>
</html>
